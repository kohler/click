%info
Pattern reconfiguration, mapping unparsing, and mapping lookup.

%script

$VALGRIND click --simtime -e "
rw1 :: IPRewriter(pattern 1.0.0.2 1024-65534# - - 0 1,
	pattern 1.0.0.3 1024-65534# - - 0 1, drop);

FromIPSummaryDump(IN1, TIMING true, STOP true)
	-> ps :: PaintSwitch
	-> [0]rw1[0]
	-> Paint(0)
	-> td :: ToIPSummaryDump(OUT1, CONTENTS link src sport dst dport tcp_seq);
ps[1] -> [1]rw1[1] -> Paint(1) -> td;
ps[2] -> [2]rw1[2] -> Paint(2) -> td;
ps[3] -> Counter(COUNT_CALL 1 s.run) -> Idle
s :: Script(TYPE PASSIVE,
  write rw1.pattern0 pattern 1.0.0.4 1024-65534# - - 0 1,
  print rw1.patterns)
DriverManager(pause,
	print >M rw1.tcp_table,
	print >RM rw1.lookup 1.0.0.2 1024 1.0.0.3 1025,
	print >>RM rw1.lookup 2.115.2.2 2 1.0.0.2 1024,
	print >>RM rw1.lookup 2.115.2.2 2 1.0.0.3 1024,
	print >>RM rw1.lookup 2.115.2.2 2 1.0.0.4 1024,
	print >>RM rw1.lookup 2.115.2.2 2 1.0.0.4 1025,
	print >>RM rw1.lookup 53.1.1.1 1 2.115.2.2 2,
	print >>RM rw1.lookup 53.1.1.2 1 2.115.2.2 2,
	print >>RM rw1.lookup 53.1.1.4 1 2.115.2.2 2,
	stop)
"

sort M

%file IN1
!proto T
!data timestamp link src sport dst dport tcp_seq
.001 0 53.1.1.1 1 2.115.2.2 2 1
.002 0 53.1.1.4 1 2.115.2.2 2 1
.003 1 2.115.2.2 2 1.0.0.2 1024 2
.004 1 53.1.1.1 1 2.115.2.2 2 3
.005 1 53.1.1.2 1 2.115.2.2 2 4
.006 2 53.1.1.3 1 2.115.2.2 2 5
.007 1 2.115.2.2 2 1.0.0.2 1024 6
.008 3 2.115.2.2 2 1.0.0.3 1024 10
.011 0 53.1.1.1 1 2.115.2.2 2 1
.012 0 53.1.1.4 1 2.115.2.2 2 1
.013 2 2.115.2.2 2 1.0.0.3 1024 40
.013 1 2.115.2.2 2 1.0.0.2 1024 2
.0135 1 2.115.2.2 2 1.0.0.4 1024 21
.014 1 53.1.1.1 1 2.115.2.2 2 3
.015 1 53.1.1.2 1 2.115.2.2 2 4
.016 2 53.1.1.3 1 2.115.2.2 2 5
.017 1 2.115.2.2 2 1.0.0.2 1024 6


%expect OUT1
0 1.0.0.2 1024 2.115.2.2 2 1
0 1.0.0.2 1025 2.115.2.2 2 1
1 2.115.2.2 2 53.1.1.1 1 2
0 1.0.0.2 1024 2.115.2.2 2 3
0 1.0.0.3 1024 2.115.2.2 2 4
1 2.115.2.2 2 53.1.1.1 1 6
0 1.0.0.4 1024 2.115.2.2 2 1
0 1.0.0.4 1025 2.115.2.2 2 1
1 2.115.2.2 2 53.1.1.2 1 40
0 1.0.0.3 1025 1.0.0.2 1024 2
1 2.115.2.2 2 53.1.1.1 1 21
0 1.0.0.4 1024 2.115.2.2 2 3
0 1.0.0.3 1024 2.115.2.2 2 4
0 1.0.0.3 1025 1.0.0.2 1024 6

%expect stdout
1.0.0.4 1024-65534 - -
1.0.0.3 1024-65534 - - [1]
<drop>
(1.0.0.2, 1024, 1.0.0.3, 1025) => (1.0.0.2, 1024, 2.115.2.2, 2) [0 *1] i1{{.*}}
(2.115.2.2, 2, 1.0.0.2, 1024) => (1.0.0.3, 1025, 1.0.0.2, 1024) [*0 1] i1{{.*}}
(2.115.2.2, 2, 1.0.0.3, 1024) => (2.115.2.2, 2, 53.1.1.2, 1) [0 *1] i1{{.*}}
(2.115.2.2, 2, 1.0.0.4, 1024) => (2.115.2.2, 2, 53.1.1.1, 1) [0 *1] i0{{.*}}
(2.115.2.2, 2, 1.0.0.4, 1025) => (2.115.2.2, 2, 53.1.1.4, 1) [0 *1] i0{{.*}}
(53.1.1.1, 1, 2.115.2.2, 2) => (1.0.0.4, 1024, 2.115.2.2, 2) [*0 1] i0{{.*}}
(53.1.1.2, 1, 2.115.2.2, 2) => (1.0.0.3, 1024, 2.115.2.2, 2) [*0 1] i1{{.*}}
(53.1.1.4, 1, 2.115.2.2, 2) => (1.0.0.4, 1025, 2.115.2.2, 2) [*0 1] i0{{.*}}

%expect RM
1.0.0.2 1024 2.115.2.2 2
1.0.0.3 1025 1.0.0.2 1024
2.115.2.2 2 53.1.1.2 1
2.115.2.2 2 53.1.1.1 1
2.115.2.2 2 53.1.1.4 1
1.0.0.4 1024 2.115.2.2 2
1.0.0.3 1024 2.115.2.2 2
1.0.0.4 1025 2.115.2.2 2

%ignorex OUT1
^!.*
