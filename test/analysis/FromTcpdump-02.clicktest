%require -q
false
# tcpdump format changes make this test unreasonable

%require -q
click-buildtool provides FromTcpdump

%script

# read from tcpdump output file; check headers, emit to a dump
click -e "
FromTcpdump(IN1, STOP true, ZERO true, CHECKSUM true)
	-> ToDump(OUT1, ENCAP IP);
"

# use tcpdump to verify dump
tcpdump -nn -tt -v -r OUT1 > OUT2

%file IN1
1073554818.366478 169.232.91.4.771 > 224.0.0.2.1985:  udp 20 [tos 0xc0]  [ttl 1] (id 37528, len 48)
1073554818.674242 169.232.91.51.1027 > 224.0.1.22.427:  udp 138 (ttl 32, id 27748, len 166)
1073554818.810540 192.168.1.100.32821 > 130.74.110.2.80: F [tcp sum ok] 132356736:132356736(0) ack 802695074 win 21600 <nop,nop,timestamp 1301380 3423736> (DF) (ttl 64, id 18639, len 52)
1073554818.886414 130.74.110.2.80 > 192.168.1.100.32821: . [tcp sum ok] ack 1 win 49152 <nop,nop,timestamp 3423757 1301380> (DF) (ttl 45, id 38002, len 52)
1073554820.210256 169.232.91.3.771 > 224.0.0.2.1985:  udp 20 [tos 0xc0]  [ttl 1] (id 43833, len 48)
1073554821.131245 169.232.91.4.769 > 224.0.0.2.1985:  udp 20 [tos 0xc0]  [ttl 1] (id 37694, len 48)
1073554822.974373 169.232.91.3.769 > 224.0.0.2.1985:  udp 20 [tos 0xc0]  [ttl 1] (id 43982, len 48)
1073554823.351129 192.168.1.100.32822 > 130.74.110.2.80: SWE [tcp sum ok] 161246674:161246674(0) win 5840 <mss 1460,sackOK,timestamp 1301834 0,nop,wscale 0> (DF) (ttl 64, id 45208, len 60)
1073554823.427822 130.74.110.2.80 > 192.168.1.100.32822: S [tcp sum ok] 808009904:808009904(0) ack 161246675 win 49152 <mss 1452,nop,wscale 0,nop,nop,timestamp 3423766 1301834,nop,nop,sackOK> (DF) (ttl 45, id 38050, len 64)
1073554823.427877 192.168.1.100.32822 > 130.74.110.2.80: . [tcp sum ok] ack 1 win 5840 <nop,nop,timestamp 1301841 3423766> (DF) (ttl 64, id 45209, len 52)
1073554823.428260 192.168.1.100.32822 > 130.74.110.2.80: P 1:592(591) ack 1 win 5840 <nop,nop,timestamp 1301842 3423766> (DF) (ttl 64, id 45210, len 643)
1073554823.506724 130.74.110.2.80 > 192.168.1.100.32822: . [tcp sum ok] ack 592 win 49152 <nop,nop,timestamp 3423766 1301842> (DF) (ttl 45, id 38051, len 52)
1073554823.527369 130.74.110.2.80 > 192.168.1.100.32822: P 1:207(206) ack 592 win 49152 <nop,nop,timestamp 3423766 1301842> (DF) (ttl 45, id 38052, len 258)
1073554823.527408 192.168.1.100.32822 > 130.74.110.2.80: . [tcp sum ok] ack 207 win 6432 <nop,nop,timestamp 1301851 3423766> (DF) (ttl 64, id 45211, len 52)
1073554823.534922 130.74.110.2.80 > 192.168.1.100.32822: P 207:399(192) ack 592 win 49152 <nop,nop,timestamp 3423766 1301842> (DF) (ttl 45, id 38053, len 244)
1073554823.534962 192.168.1.100.32822 > 130.74.110.2.80: . [tcp sum ok] ack 399 win 7504 <nop,nop,timestamp 1301852 3423766> (DF) (ttl 64, id 45212, len 52)
1073554823.895782 169.232.91.4.769 > 224.0.0.2.1985:  udp 20 [tos 0xc0]  [ttl 1] (id 37827, len 48)
1073554824.038406 130.74.110.2.80 > 192.168.1.100.32822: . 399:1839(1440) ack 592 win 49152 <nop,nop,timestamp 3423767 1301842> (DF) (ttl 45, id 38054, len 1492)
1073554824.038468 192.168.1.100.32822 > 130.74.110.2.80: . [tcp sum ok] ack 1839 win 10080 <nop,nop,timestamp 1301903 3423767> (DF) (ttl 64, id 45213, len 52)
1073554824.041561 130.74.110.2.80 > 192.168.1.100.32822: P 3279:4503(1224) ack 592 win 49152 <nop,nop,timestamp 3423767 1301842> (DF) (ttl 45, id 38056, len 1276)
1073554824.041605 192.168.1.100.32822 > 130.74.110.2.80: . [tcp sum ok] ack 1839 win 10080 <nop,nop,timestamp 1301903 3423767,nop,nop,sack sack 1 {3279:4503} > (DF) (ttl 64, id 45214, len 64)
1073554824.044220 130.74.110.2.80 > 192.168.1.100.32822: . 1839:3279(1440) ack 592 win 49152 <nop,nop,timestamp 3423767 1301842> (DF) (ttl 45, id 38055, len 1492)
1073554824.044243 192.168.1.100.32822 > 130.74.110.2.80: . [tcp sum ok] ack 4503 win 12960 <nop,nop,timestamp 1301903 3423767> (DF) (ttl 64, id 45215, len 52)
1073554824.059866 130.74.110.2.80 > 192.168.1.100.32822: . 4503:5943(1440) ack 592 win 49152 <nop,nop,timestamp 3423767 1301842> (DF) (ttl 45, id 38057, len 1492)
1073554824.059909 192.168.1.100.32822 > 130.74.110.2.80: . [tcp sum ok] ack 5943 win 15840 <nop,nop,timestamp 1301905 3423767> (DF) (ttl 64, id 45216, len 52)
1073554824.120411 130.74.110.2.80 > 192.168.1.100.32822: P 5943:6577(634) ack 592 win 49152 <nop,nop,timestamp 3423767 1301842> (DF) (ttl 45, id 38058, len 686)
1073554824.120453 192.168.1.100.32822 > 130.74.110.2.80: . [tcp sum ok] ack 6577 win 18720 <nop,nop,timestamp 1301911 3423767> (DF) (ttl 64, id 45217, len 52)
1073554826.661102 169.232.91.4.771 > 224.0.0.2.1985:  udp 20 [tos 0xc0]  [ttl 1] (id 37987, len 48)
1073554828.196800 169.232.91.3.769 > 224.0.0.2.1985:  udp 20 [tos 0xc0]  [ttl 1] (id 44252, len 48)
1073554828.521763 192.168.1.100.32784 > 192.150.187.37.22: P 760652358:760652406(48) ack 300862828 win 32800 <nop,nop,timestamp 1302351 400329112> (DF) [tos 0x10]  (ttl 64, id 40281, len 100)
1073554828.541929 192.150.187.37.22 > 192.168.1.100.32784: P 1:81(80) ack 48 win 57600 <nop,nop,timestamp 400702930 1302351> (DF) [tos 0x10]  (ttl 54, id 38410, len 132)
1073554828.541988 192.168.1.100.32784 > 192.150.187.37.22: . [tcp sum ok] ack 81 win 32800 <nop,nop,timestamp 1302353 400702930> (DF) [tos 0x10]  (ttl 64, id 40282, len 52)
1073554828.558270 192.150.187.37.22 > 192.168.1.100.32784: P 81:145(64) ack 48 win 57600 <nop,nop,timestamp 400702932 1302353> (DF) [tos 0x10]  (ttl 54, id 38412, len 116)
1073554828.558325 192.168.1.100.32784 > 192.150.187.37.22: . [tcp sum ok] ack 145 win 32800 <nop,nop,timestamp 1302355 400702932> (DF) [tos 0x10]  (ttl 64, id 40283, len 52)
1073554828.578726 192.150.187.37.22 > 192.168.1.100.32784: P 145:609(464) ack 48 win 57600 <nop,nop,timestamp 400702934 1302355> (DF) [tos 0x10]  (ttl 54, id 38413, len 516)
1073554828.578768 192.168.1.100.32784 > 192.150.187.37.22: . [tcp sum ok] ack 609 win 32800 <nop,nop,timestamp 1302357 400702934> (DF) [tos 0x10]  (ttl 64, id 40284, len 52)
1073554828.579812 192.150.187.37.22 > 192.168.1.100.32784: P 609:897(288) ack 48 win 57600 <nop,nop,timestamp 400702934 1302355> (DF) [tos 0x10]  (ttl 54, id 38414, len 340)
1073554828.579833 192.168.1.100.32784 > 192.150.187.37.22: . [tcp sum ok] ack 897 win 32800 <nop,nop,timestamp 1302357 400702934> (DF) [tos 0x10]  (ttl 64, id 40285, len 52)
1073554828.582370 192.150.187.37.22 > 192.168.1.100.32784: P 897:1009(112) ack 48 win 57600 <nop,nop,timestamp 400702934 1302355> (DF) [tos 0x10]  (ttl 54, id 38415, len 164)
1073554828.582384 192.168.1.100.32784 > 192.150.187.37.22: . [tcp sum ok] ack 1009 win 32800 <nop,nop,timestamp 1302357 400702934> (DF) [tos 0x10]  (ttl 64, id 40286, len 52)
1073554829.425637 169.232.91.4.769 > 224.0.0.2.1985:  udp 20 [tos 0xc0]  [ttl 1] (id 38137, len 48)
1073554831.575698 169.232.91.3.771 > 224.0.0.2.1985:  udp 20 [tos 0xc0]  [ttl 1] (id 44446, len 48)
1073554832.497370 169.232.91.4.771 > 224.0.0.2.1985:  udp 20 [tos 0xc0]  [ttl 1] (id 38310, len 48)

%cut %expect OUT2
1073554818.366478 169.232.91.4.771 > 224.0.0.2.1985:{{ +(\[\|hsrp\]|udp 20)}} [tos 0xc0]  [ttl 1] (id 37528, len 48)
1073554818.674242 169.232.91.51.1027 > 224.0.1.22.427:{{ +}}udp 138 (ttl 32, id 27748, len 166)
1073554818.810540 192.168.1.100.32821 > 130.74.110.2.80: F [tcp sum ok] 132356736:132356736(0) ack 802695074 win 21600 <nop,nop,timestamp 1301380 3423736> (DF) (ttl 64, id 18639, len 52)
1073554818.886414 130.74.110.2.80 > 192.168.1.100.32821: . [tcp sum ok] ack 1 win 49152 <nop,nop,timestamp 3423757 1301380> (DF) (ttl 45, id 38002, len 52)
1073554820.210256 169.232.91.3.771 > 224.0.0.2.1985:{{ +(\[\|hsrp\]|udp 20)}} [tos 0xc0]  [ttl 1] (id 43833, len 48)
1073554821.131245 169.232.91.4.769 > 224.0.0.2.1985:{{ +(\[\|hsrp\]|udp 20)}} [tos 0xc0]  [ttl 1] (id 37694, len 48)
1073554822.974373 169.232.91.3.769 > 224.0.0.2.1985:{{ +(\[\|hsrp\]|udp 20)}} [tos 0xc0]  [ttl 1] (id 43982, len 48)
1073554823.351129 192.168.1.100.32822 > 130.74.110.2.80: SWE [tcp sum ok] 161246674:161246674(0) win 5840 <mss 1460,sackOK,timestamp 1301834 0,nop,wscale 0> (DF) (ttl 64, id 45208, len 60)
1073554823.427822 130.74.110.2.80 > 192.168.1.100.32822: S [tcp sum ok] 808009904:808009904(0) ack 161246675 win 49152 <mss 1452,nop,wscale 0,nop,nop,timestamp 3423766 1301834,nop,nop,sackOK> (DF) (ttl 45, id 38050, len 64)
1073554823.427877 192.168.1.100.32822 > 130.74.110.2.80: . [tcp sum ok] ack 1 win 5840 <nop,nop,timestamp 1301841 3423766> (DF) (ttl 64, id 45209, len 52)
1073554823.428260 192.168.1.100.32822 > 130.74.110.2.80: P 1:592(591) ack 1 win 5840 <nop,nop,timestamp 1301842 3423766> (DF) (ttl 64, id 45210, len 643)
1073554823.506724 130.74.110.2.80 > 192.168.1.100.32822: . [tcp sum ok] ack 592 win 49152 <nop,nop,timestamp 3423766 1301842> (DF) (ttl 45, id 38051, len 52)
1073554823.527369 130.74.110.2.80 > 192.168.1.100.32822: P 1:207(206) ack 592 win 49152 <nop,nop,timestamp 3423766 1301842> (DF) (ttl 45, id 38052, len 258)
1073554823.527408 192.168.1.100.32822 > 130.74.110.2.80: . [tcp sum ok] ack 207 win 6432 <nop,nop,timestamp 1301851 3423766> (DF) (ttl 64, id 45211, len 52)
1073554823.534922 130.74.110.2.80 > 192.168.1.100.32822: P 207:399(192) ack 592 win 49152 <nop,nop,timestamp 3423766 1301842> (DF) (ttl 45, id 38053, len 244)
1073554823.534962 192.168.1.100.32822 > 130.74.110.2.80: . [tcp sum ok] ack 399 win 7504 <nop,nop,timestamp 1301852 3423766> (DF) (ttl 64, id 45212, len 52)
1073554823.895782 169.232.91.4.769 > 224.0.0.2.1985:{{ +(\[\|hsrp\]|udp 20)}} [tos 0xc0]  [ttl 1] (id 37827, len 48)
1073554824.038406 130.74.110.2.80 > 192.168.1.100.32822: . 399:1839(1440) ack 592 win 49152 <nop,nop,timestamp 3423767 1301842> (DF) (ttl 45, id 38054, len 1492)
1073554824.038468 192.168.1.100.32822 > 130.74.110.2.80: . [tcp sum ok] ack 1839 win 10080 <nop,nop,timestamp 1301903 3423767> (DF) (ttl 64, id 45213, len 52)
1073554824.041561 130.74.110.2.80 > 192.168.1.100.32822: P 3279:4503(1224) ack 592 win 49152 <nop,nop,timestamp 3423767 1301842> (DF) (ttl 45, id 38056, len 1276)
1073554824.041605 192.168.1.100.32822 > 130.74.110.2.80: . [tcp sum ok] ack 1839 win 10080 <nop,nop,timestamp 1301903 3423767,nop,nop,sack sack 1 {3279:4503} > (DF) (ttl 64, id 45214, len 64)
1073554824.044220 130.74.110.2.80 > 192.168.1.100.32822: . 1839:3279(1440) ack 592 win 49152 <nop,nop,timestamp 3423767 1301842> (DF) (ttl 45, id 38055, len 1492)
1073554824.044243 192.168.1.100.32822 > 130.74.110.2.80: . [tcp sum ok] ack 4503 win 12960 <nop,nop,timestamp 1301903 3423767> (DF) (ttl 64, id 45215, len 52)
1073554824.059866 130.74.110.2.80 > 192.168.1.100.32822: . 4503:5943(1440) ack 592 win 49152 <nop,nop,timestamp 3423767 1301842> (DF) (ttl 45, id 38057, len 1492)
1073554824.059909 192.168.1.100.32822 > 130.74.110.2.80: . [tcp sum ok] ack 5943 win 15840 <nop,nop,timestamp 1301905 3423767> (DF) (ttl 64, id 45216, len 52)
1073554824.120411 130.74.110.2.80 > 192.168.1.100.32822: P 5943:6577(634) ack 592 win 49152 <nop,nop,timestamp 3423767 1301842> (DF) (ttl 45, id 38058, len 686)
1073554824.120453 192.168.1.100.32822 > 130.74.110.2.80: . [tcp sum ok] ack 6577 win 18720 <nop,nop,timestamp 1301911 3423767> (DF) (ttl 64, id 45217, len 52)
1073554826.661102 169.232.91.4.771 > 224.0.0.2.1985:{{ +(\[\|hsrp\]|udp 20)}} [tos 0xc0]  [ttl 1] (id 37987, len 48)
1073554828.196800 169.232.91.3.769 > 224.0.0.2.1985:{{ +(\[\|hsrp\]|udp 20)}} [tos 0xc0]  [ttl 1] (id 44252, len 48)
1073554828.521763 192.168.1.100.32784 > 192.150.187.37.22: P 760652358:760652406(48) ack 300862828 win 32800 <nop,nop,timestamp 1302351 400329112> (DF) [tos 0x10]  (ttl 64, id 40281, len 100)
1073554828.541929 192.150.187.37.22 > 192.168.1.100.32784: P 1:81(80) ack 48 win 57600 <nop,nop,timestamp 400702930 1302351> (DF) [tos 0x10]  (ttl 54, id 38410, len 132)
1073554828.541988 192.168.1.100.32784 > 192.150.187.37.22: . [tcp sum ok] ack 81 win 32800 <nop,nop,timestamp 1302353 400702930> (DF) [tos 0x10]  (ttl 64, id 40282, len 52)
1073554828.558270 192.150.187.37.22 > 192.168.1.100.32784: P 81:145(64) ack 48 win 57600 <nop,nop,timestamp 400702932 1302353> (DF) [tos 0x10]  (ttl 54, id 38412, len 116)
1073554828.558325 192.168.1.100.32784 > 192.150.187.37.22: . [tcp sum ok] ack 145 win 32800 <nop,nop,timestamp 1302355 400702932> (DF) [tos 0x10]  (ttl 64, id 40283, len 52)
1073554828.578726 192.150.187.37.22 > 192.168.1.100.32784: P 145:609(464) ack 48 win 57600 <nop,nop,timestamp 400702934 1302355> (DF) [tos 0x10]  (ttl 54, id 38413, len 516)
1073554828.578768 192.168.1.100.32784 > 192.150.187.37.22: . [tcp sum ok] ack 609 win 32800 <nop,nop,timestamp 1302357 400702934> (DF) [tos 0x10]  (ttl 64, id 40284, len 52)
1073554828.579812 192.150.187.37.22 > 192.168.1.100.32784: P 609:897(288) ack 48 win 57600 <nop,nop,timestamp 400702934 1302355> (DF) [tos 0x10]  (ttl 54, id 38414, len 340)
1073554828.579833 192.168.1.100.32784 > 192.150.187.37.22: . [tcp sum ok] ack 897 win 32800 <nop,nop,timestamp 1302357 400702934> (DF) [tos 0x10]  (ttl 64, id 40285, len 52)
1073554828.582370 192.150.187.37.22 > 192.168.1.100.32784: P 897:1009(112) ack 48 win 57600 <nop,nop,timestamp 400702934 1302355> (DF) [tos 0x10]  (ttl 54, id 38415, len 164)
1073554828.582384 192.168.1.100.32784 > 192.150.187.37.22: . [tcp sum ok] ack 1009 win 32800 <nop,nop,timestamp 1302357 400702934> (DF) [tos 0x10]  (ttl 64, id 40286, len 52)
1073554829.425637 169.232.91.4.769 > 224.0.0.2.1985:{{ +(\[\|hsrp\]|udp 20)}} [tos 0xc0]  [ttl 1] (id 38137, len 48)
1073554831.575698 169.232.91.3.771 > 224.0.0.2.1985:{{ +(\[\|hsrp\]|udp 20)}} [tos 0xc0]  [ttl 1] (id 44446, len 48)
1073554832.497370 169.232.91.4.771 > 224.0.0.2.1985:{{ +(\[\|hsrp\]|udp 20)}} [tos 0xc0]  [ttl 1] (id 38310, len 48)

%ignorex
!.*

%eof
